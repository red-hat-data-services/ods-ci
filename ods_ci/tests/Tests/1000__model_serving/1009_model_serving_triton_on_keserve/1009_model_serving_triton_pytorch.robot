*** Settings ***
Documentation     Suite of test cases for OVMS in Kserve
Library           OperatingSystem
Library           ../../../../../libs/Helpers.py
Resource          ../../../Resources/Page/ODH/JupyterHub/HighAvailability.robot
Resource          ../../../Resources/Page/ODH/ODHDashboard/ODHModelServing.resource
Resource          ../../../Resources/Page/ODH/ODHDashboard/ODHDataScienceProject/Projects.resource
Resource          ../../../Resources/Page/ODH/ODHDashboard/ODHDataScienceProject/DataConnections.resource
Resource          ../../../Resources/Page/ODH/ODHDashboard/ODHDataScienceProject/ModelServer.resource
Resource          ../../../Resources/Page/ODH/ODHDashboard/ODHDashboardSettingsRuntimes.resource
Resource          ../../../Resources/Page/ODH/Monitoring/Monitoring.resource
Resource          ../../../Resources/OCP.resource
Resource          ../../../Resources/CLI/ModelServing/modelmesh.resource
Suite Setup       Triton On Kserve Suite Setup
Suite Teardown    Triton On Kserve Suite Teardown
Test Tags         Kserve

*** Variables ***
${INFERENCE_REST_INPUT_PYTORCH}=    @tests/Resources/Files/triton/pytorch_resnet50_input.json
${PRJ_TITLE}=    model-serving-triton-project-resnet50
${PRJ_DESCRIPTION}=    project used for model serving triton runtime tests
${MODEL_CREATED}=    ${FALSE}
${MODEL_NAME}=    resnet50
${RUNTIME_NAME}=    kserve-tritonserver-pytorch-rest
${RESOURCES_DIRPATH}=        tests/Resources/Files/triton
${TRITON_RUNTIME_FILEPATH}=    ${RESOURCES_DIRPATH}/kserve_resnet50_rest_serving_runtime.yaml
${EXPECTED_INFERENCE_REST_OUTPUT_PYTORCH}=        {"model_name":"resnet50","model_version":"1","outputs":[{"name":"output__0","datatype":"FP32","shape":[1,1000,1,1],"data":[-2.0247793197631836,-0.9921608567237854,-0.05299587547779083,-0.41587281227111816,-0.7928302884101868,-1.1406428813934326,-0.854307234287262,-1.020595908164978,-1.333804965019226,-1.036041259765625,0.3704487681388855,1.081409215927124,0.6524502038955688,1.0303505659103394,-0.2501419484615326,0.4022282660007477,0.7712092399597168,-0.31191572546958923,0.9340399503707886,1.1759955883026123,-0.6011471748352051,1.5368283987045288,1.0316851139068604,1.2842328548431396,0.5333061814308167,-0.5786338448524475,-0.5359994173049927,0.3048454821109772,0.011570842936635017,-1.727175235748291,-2.660287380218506,-0.06341726332902908,-2.4711861610412598,-1.6360716819763184,0.2401006668806076,-1.9610031843185425,-0.7015184760093689,-1.713377833366394,0.8035755157470703,-0.7349295616149902,0.10919835418462753,-0.983664333820343,0.4983326494693756,-0.25582194328308105,0.45230066776275635,0.3856111764907837,0.2813134789466858,-1.4142862558364868,-0.7714354395866394,-1.5171056985855103,1.0013935565948486,-1.2239973545074463,0.40928423404693604,-0.20218047499656677,0.2662369906902313,-0.6056059002876282,-0.12249699234962463,-0.3268387019634247,-0.6640905141830444,0.6670411825180054,0.722800076007843,0.4649980068206787,-0.27542224526405334,0.1382571905851364,0.46496137976646423,0.20428290963172913,0.7233375310897827,-0.2560654878616333,1.053549885749817,3.579087734222412,0.05920775234699249,2.4844448566436768,-0.0867457166314125,1.4617496728897095,-0.07509591430425644,2.1603357791900635,0.7267593145370483,1.970470666885376,3.135693073272705,3.8296079635620117,1.0243455171585083,1.2682546377182007,0.22456781566143036,0.26896485686302185,-0.4969382584095001,1.3749146461486816,-0.26176539063453674,1.890173316001892,0.2533363103866577,1.6064037084579468,-0.7522174715995789,0.20337402820587158,1.4124077558517456,0.43283557891845703,1.018230676651001,-1.850403070449829,0.36746925115585327,-1.614242434501648,0.37772810459136963,0.7593181729316711,0.1872769445180893,-0.48240330815315247,0.007280305027961731,0.9506487846374512,-0.7945019602775574,-1.245593786239624,-1.0462896823883057,-0.6869955062866211,-2.419619560241699,-1.2921690940856934,0.40995079278945923,2.229761838912964,-0.313252329826355,0.5769896507263184,0.9176836609840393,-2.982309579849243,-1.47837233543396,-0.46886739134788513,-1.9136414527893066,-2.839846134185791,-0.4488708972930908,-3.235321044921875,-2.6617515087127686,-2.5031747817993164,-2.6059908866882324,-1.2883391380310059,1.3086291551589966,1.0314247608184814,1.9910576343536377,-0.2607671320438385,-1.7249555587768555,-0.39792779088020325,0.26989123225212097,0.31467992067337036,0.021849794313311577,0.01402416080236435,-1.7918519973754883,0.7959520816802979,1.6831145286560059,-0.413263201713562,-0.042633965611457825,0.6920806765556335,-0.46043461561203003,0.46024665236473083,-0.6324272751808167,0.7179017663002014,0.9212760925292969,-0.1878172904253006,-0.9259064793586731,-1.5427930355072021,-1.0737874507904053,0.9618874788284302,-1.5437027215957642,0.0726296529173851,-0.6011502146720886,-0.7654620409011841,-1.1695395708084106,-0.46508079767227173,-0.6201334595680237,-0.33738821744918823,-1.8491308689117432,-0.5275655388832092,-0.21382512152194977,-0.9397990107536316,0.17965246737003326,-0.642216145992279,-1.0935295820236206,-2.226257085800171,-1.0807453393936157,-0.649274468421936,-1.7311440706253052,-0.021125581115484238,-0.7605778574943542,-0.5685591697692871,-1.0461251735687256,-1.8380467891693115,-2.2596352100372314,-1.1328575611114502,-0.2095850259065628,-1.4646183252334595,-1.4853655099868774,-0.836053192615509,-0.8549250960350037,-0.4841022193431854,-1.5710853338241577,-0.8663458824157715,-1.0455687046051025,0.6740971207618713,-1.7827873229980469,-0.2086527794599533,-0.6039509773254395,-1.0741474628448486,-0.5862270593643188,-0.20074115693569183,-1.670734167098999,0.18080966174602509,-1.4527920484542847,-2.6436569690704346,-2.4497368335723877,-0.9529370069503784,-1.5425399541854858,-1.3601341247558594,0.5146624445915222,-0.4231233298778534,-0.9336349964141846,-1.8899770975112915,-1.3611080646514893,-1.8001070022583008,-1.0033941268920898,-1.0587127208709717,-1.293064832687378,-1.2475117444992065,-1.5562434196472168,-1.6115546226501465,-1.365669846534729,-0.5865814685821533,-0.48000332713127136,-0.7910575270652771,-1.731697678565979,-1.4630777835845947,-2.3271732330322266,-0.8049450516700745,-1.8952351808547974,-0.6197623014450073,-1.6051105260849,-0.4585658013820648,-2.6589746475219727,-1.3504855632781982,-1.431890606880188,-1.1998066902160645,-1.4237040281295776,-1.5002014636993408,-1.0568926334381104,-2.50357723236084,-1.0262733697891235,-0.5603089332580566,0.031941547989845276,0.9071351289749146,-0.6022788286209106,-2.054044723510742,-1.6060106754302979,-0.7883329391479492,-0.9934788346290588,-0.7039735317230225,-2.7580127716064453,0.07733438909053802,-0.4339299201965332,-1.1342341899871826,-0.2760429382324219,-0.043043896555900574,-0.6854031682014465,-0.24207133054733276,-2.1181352138519287,-0.8085023760795593,0.28596505522727966,-2.344428777694702,-0.9442521929740906,-0.9155909419059753,-0.37289509177207947,-0.48641616106033325,-1.0277037620544434,-0.7609120607376099,-1.9840975999832153,-0.26712146401405334,-0.9991052150726318,0.1443171501159668,-0.9967935681343079,-2.1109602451324463,-1.2063324451446533,-1.6056861877441406,-0.14492370188236237,-2.3920974731445312,0.2033718079328537,-0.09708818793296814,-1.3546059131622314,-0.21275374293327332,0.5934434533119202,0.05272131785750389,-1.1918176412582397,0.3267575800418854,-0.029870159924030304,1.8205646276474,1.4267277717590332,1.794242262840271,1.1260372400283813,1.075860619544983,-1.6290559768676758,-1.7393990755081177,-0.5500372052192688,-1.0928881168365479,-1.9159560203552246,-0.3893425464630127,-0.5884779095649719,0.5024561285972595,-0.37410295009613037,-0.8385095000267029,0.28199100494384766,-1.0069085359573364,0.7376977801322937,0.385988712310791,-0.4206233620643616,1.7697404623031616,0.20158737897872925,0.7667743563652039,0.04521242529153824,-0.6421210765838623,0.8913363218307495,1.278687596321106,1.0295233726501465,-1.1396701335906982,3.0835163593292236,0.10639253258705139,0.14412514865398407,2.320322275161743,2.356008768081665,0.9314624071121216,0.6660897135734558,0.15413714945316315,2.296745538711548,0.4706580638885498,-0.05699659138917923,-2.337533712387085,-1.9012653827667236,-1.6571062803268433,-1.8160308599472046,-1.7889182567596436,-0.8582068085670471,-0.8657644987106323,-2.5046889781951904,-3.001347064971924,0.7046827673912048,0.6325764656066895,0.12922349572181702,-0.9238867163658142,-0.36717528104782104,-0.12311036884784698,-0.7761710286140442,-1.1445720195770264,0.17671069502830505,-1.2734689712524414,-0.28360700607299805,-2.2445309162139893,-1.862002968788147,-2.019045829772949,-1.1387889385223389,-1.1470184326171875,-1.2585694789886475,-1.4356346130371094,-0.5260803699493408,0.09788957983255386,-0.5769028067588806,-0.10501108318567276,-1.248722791671753,-0.012646229937672615,0.3768925368785858,-1.639986276626587,1.3723043203353882,0.21054910123348236,0.44227129220962524,1.1158400774002075,-0.651270866394043,0.6430606245994568,-0.12691670656204224,-0.2594127058982849,-1.212011694908142,-1.4850646257400513,-1.2703827619552612,-0.2954292297363281,-0.8104463219642639,-2.0214104652404785,-0.7191883325576782,-1.6715143918991089,-0.7012206315994263,-1.0886911153793335,0.004740241914987564,-1.3360671997070312,-0.8866799473762512,-0.014641856774687767,-1.5680241584777832,-1.5796364545822144,-2.066868782043457,-0.8181829452514648,-0.4117566645145416,-0.15862935781478882,-2.5868561267852783,-1.4371693134307861,-0.014219587668776512,-1.3987915515899658,-1.6841715574264526,-1.3436449766159058,-1.1982967853546143,-0.6020458340644836,-0.9586261510848999,-2.8010504245758057,-1.4298266172409058,-0.8760696053504944,-2.3933944702148438,-0.45848432183265686,0.5812476277351379,2.438347339630127,-0.8578243851661682,-0.78936368227005,1.6988203525543213,-0.9763985872268677,-0.09819062054157257,0.8779950141906738,-1.2444171905517578,-1.4573862552642822,-1.6756452322006226,1.3940198421478271,-2.3346989154815674,2.069786548614502,1.3160099983215332,1.954233169555664,2.5358402729034424,-2.280507802963257,0.49241843819618225,-0.07477831840515137,3.868906021118164,1.3290715217590332,1.1563001871109009,2.2287557125091553,-0.9421390891075134,-0.6672687530517578,-1.5089696645736694,-0.5666619539260864,2.442173480987549,0.1641540378332138,-1.3136485815048218,0.47600093483924866,-0.25245076417922974,0.5898987054824829,1.880723476409912,0.5152871012687683,1.6708084344863892,0.09840187430381775,-1.4643478393554688,0.14204800128936768,0.0328601635992527,0.42436909675598145,1.0292143821716309,0.6309747695922852,0.42131754755973816,2.577336311340332,-0.39629513025283813,-1.8293371200561523,5.1405439376831055,0.763213038444519,0.510044276714325,-1.3903865814208984,-1.0697304010391235,2.329881191253662,0.45137956738471985,0.0660141259431839,-1.504034161567688,1.5473283529281616,0.41297647356987,1.4074777364730835,3.0180699825286865,0.8700193762779236,0.508461058139801,2.090327262878418,2.6324334144592285,0.009082802571356297,2.858355760574341,3.831851005554199,-1.8726069927215576,-3.262136459350586,-1.3230690956115723,-0.7088785767555237,0.4603452682495117,-0.5438786745071411,-1.9236071109771729,2.156245231628418,1.9211808443069458,-1.0953925848007202,-3.9906575679779053,1.3155924081802368,2.875779151916504,-1.4135898351669312,1.8244695663452148,2.650977611541748,0.6427057981491089,-1.4431707859039307,-1.0288255214691162,0.49447986483573914,-0.5358971953392029,1.5263774394989014,3.8660178184509277,1.0187182426452637,3.886579990386963,-0.1350667029619217,1.639963984489441,0.1612718254327774,0.6984425783157349,-0.3308294415473938,0.9472362995147705,-1.3630008697509766,0.09515367448329926,2.9325239658355713,0.7931398153305054,2.232804298400879,1.8663173913955688,0.9148984551429749,1.4003123044967651,1.5292190313339233,0.4911283850669861,2.036949396133423,1.6694039106369019,-2.7237091064453125,-0.9272893667221069,-1.1324098110198975,2.502671718597412,2.0213351249694824,1.564324140548706,1.1970760822296143,0.6554586887359619,0.8087673187255859,-0.5695462226867676,0.669826865196228,0.6198313236236572,-1.008504033088684,-1.646995186805725,1.063463568687439,1.9520982503890991,-0.8923941254615784,0.14662712812423706,0.4891200363636017,0.8148918747901917,0.40393489599227905,1.480872392654419,0.7231874465942383,-0.2680136561393738,2.193579912185669,3.013558864593506,-2.0380191802978516,-1.7014416456222534,-0.2241554856300354,-0.4325733184814453,3.7173948287963867,-0.7806435823440552,-0.03548305109143257,1.289844036102295,1.0462815761566162,-1.7610557079315186,1.7524371147155762,0.9997671842575073,-2.6477982997894287,0.09428343921899796,4.822382926940918,0.5211765766143799,0.6465187072753906,0.35523390769958496,1.4302668571472168,-0.2764563262462616,-2.403930187225342,4.7108259201049805,0.5499446988105774,1.9852656126022339,2.2110815048217773,-0.12150248140096664,-1.400898814201355,-0.7304152250289917,3.1687912940979004,-0.7915239334106445,0.01456653792411089,0.29730546474456787,0.7440613508224487,1.2486971616744995,-2.776934862136841,0.86875981092453,-1.7226762771606445,0.8598699569702148,-1.137282133102417,0.6796136498451233,-1.937678575515747,-2.080172538757324,0.02431408315896988,0.2751065194606781,-0.27937328815460205,-1.4960968494415283,-1.303491473197937,-3.6464264392852783,2.0359814167022705,1.3628813028335571,0.5913984775543213,-0.9347155094146729,2.731860637664795,3.5479607582092285,1.2473342418670654,-0.3108732998371124,2.583207845687866,1.0999330282211304,0.5831948518753052,0.5220658779144287,-1.3619575500488281,3.627807140350342,2.9691169261932373,-0.13882498443126678,0.5132569670677185,4.035043716430664,1.8406617641448975,-0.10619551688432693,-2.890955924987793,1.9299429655075073,1.105265736579895,2.035536050796509,-0.48635172843933105,2.446139335632324,-2.837054967880249,5.0701704025268555,1.2032955884933472,-1.2045164108276367,2.0867295265197754,-0.3549826443195343,1.4063681364059448,2.868938446044922,-0.49790605902671814,2.952995777130127,3.4981396198272705,3.016228675842285,-1.4940882921218872,2.0304644107818604,3.410285711288452,-1.2811949253082275,-1.1550368070602417,3.1213605403900146,-1.6320433616638184,0.23101021349430084,2.363816738128662,1.4727307558059692,0.7773081064224243,2.4727354049682617,2.5754854679107666,-2.531287670135498,0.9501190185546875,2.5496532917022705,-0.22860266268253326,0.521457314491272,0.3892676830291748,1.9952266216278076,-0.1542275846004486,0.3873814642429352,1.0884997844696045,3.5096209049224854,-2.0721709728240967,0.1845570057630539,0.3430826663970947,0.967516303062439,0.022968444973230362,1.9337151050567627,1.022274374961853,0.32419735193252563,0.618864119052887,-2.1646296977996826,1.8979721069335938,-2.227365493774414,1.2055867910385132,0.22350502014160156,0.09432338923215866,-1.713517189025879,-2.2135729789733887,3.5232911109924316,-1.0369216203689575,1.6200352907180786,-1.128786563873291,0.14534629881381989,1.3078032732009888,-2.1656250953674316,1.1680322885513306,-1.0926439762115479,-1.9246519804000854,-0.4219229221343994,1.0342445373535156,2.6147360801696777,-2.0325708389282227,0.06339222937822342,3.985969066619873,0.7923896908760071,3.524812936782837,0.9486792683601379,2.6893162727355957,0.870220422744751,1.928513765335083,0.5724818110466003,-0.6382943987846375,0.7371187806129456,-1.5687471628189087,0.6343086957931519,0.5780156254768372,-3.3004908561706543,-0.7001520991325378,2.361021041870117,0.9721456170082092,-1.8905466794967651,2.2501296997070312,1.6317309141159058,-0.5514748692512512,-1.8144164085388184,1.4896905422210693,2.3871541023254395,1.5862549543380737,-0.015016079880297184,-0.17175497114658356,0.3827729821205139,-2.2823734283447266,-1.1987731456756592,0.45319128036499023,0.9281459450721741,1.5688087940216064,0.8589338064193726,2.138932466506958,0.01779230311512947,0.8118128180503845,1.9999231100082397,0.3032694458961487,0.6699662804603577,-3.7537341117858887,0.2004384696483612,-0.06655649840831757,1.18199622631073,3.4185807704925537,1.6338075399398804,-1.0131473541259766,0.1326487958431244,1.2617658376693726,0.16394272446632385,-0.13826437294483185,1.2632315158843994,1.230998158454895,0.08812102675437927,1.7691651582717896,0.789459764957428,0.9676878452301025,-2.2178337574005127,3.017329216003418,1.2155166864395142,0.523557722568512,0.3979528844356537,-1.6383965015411377,1.4568709135055542,1.9870935678482056,0.505236804485321,-0.01996033638715744,0.7205281257629395,-0.3779594302177429,0.8144275546073914,1.185710072517395,2.1144845485687256,2.265713930130005,1.6556028127670288,-2.104484796524048,0.9774632453918457,2.625861883163452,0.5312738418579102,-0.9321174621582031,-0.21277639269828796,-1.99159574508667,-0.5978618860244751,1.212828516960144,3.4834322929382324,1.8089802265167236,-2.998991012573242,4.006580352783203,3.3122942447662354,0.5820256471633911,-1.5071806907653809,1.8765074014663696,-1.1072015762329102,3.2576711177825928,0.7681072950363159,2.4594292640686035,3.6307008266448975,1.166675090789795,0.8795588612556458,-1.2323272228240967,1.5447620153427124,3.229736804962158,1.7851378917694092,-1.364395260810852,0.05426637828350067,-0.4277520775794983,2.2795097827911377,4.923381328582764,3.6628968715667725,0.1707330048084259,0.9763141870498657,1.052773118019104,-1.1261078119277954,2.59854793548584,1.0484029054641724,-0.09271183609962463,1.8177229166030884,1.1631274223327637,3.3711893558502197,-0.6396028995513916,1.0857123136520386,1.0673404932022095,2.3691864013671875,0.915026068687439,-1.6581066846847534,-1.355000615119934,-1.420851707458496,-0.7691636681556702,2.3859024047851562,-0.8404794931411743,0.6196934580802917,-1.1662276983261108,-0.3139972686767578,-1.1092272996902466,1.0812994241714478,1.9737645387649536,1.6755306720733643,1.421483039855957,-1.202175498008728,1.4154205322265625,0.38869285583496094,-2.8311281204223633,0.6921327710151672,-1.976662278175354,-2.2890841960906982,-2.0656912326812744,-1.2751294374465942,0.5081120729446411,1.197177529335022,0.12156718969345093,1.7544646263122559,-0.020159319043159485,3.097421646118164,-2.1626996994018555,0.40990498661994934,2.4201414585113525,-1.6130707263946533,0.8584405779838562,1.8176615238189697,-0.10026688128709793,0.33904948830604553,1.1990504264831543,-0.5113562941551208,-1.135481834411621,1.54215407371521,2.860135555267334,0.03384331986308098,-1.1069276332855225,4.150540828704834,3.0589168071746826,2.2770566940307617,-1.3595219850540161,0.05419670417904854,1.075439214706421,0.5701701045036316,1.9159470796585083,1.4319592714309692,0.3080004155635834,-0.20652148127555847,2.0885848999023438,-2.9661037921905518,0.40664154291152954,1.5939422845840454,1.3975993394851685,-1.5359636545181274,1.4335156679153442,-0.6088399887084961,-0.6214863657951355,-2.9783685207366943,-2.9415695667266846,-2.0613062381744385,-1.9683763980865479,1.9645687341690063,2.1087796688079834,-0.6631877422332764,-1.5008337497711182,2.1004319190979004,-0.29084524512290955,-3.970994234085083,0.774614691734314,-0.10501639544963837,-0.7073017358779907,0.6008784770965576,1.6123569011688232,-0.13200010359287262,0.7118274569511414,1.2247412204742432,0.8188934326171875,-0.0008978259284049273,1.7649238109588623,-0.07088223844766617,-1.4360523223876953,-1.9582669734954834,0.1315285712480545,-3.0323493480682373,0.4263181984424591,4.756340503692627,4.023977279663086,1.9825353622436523,0.09579263627529144,1.3818793296813965,0.9103924632072449,1.118933916091919,0.4180070459842682,-0.5536695718765259,0.5137543082237244,2.8405511379241943,1.625567078590393,3.4743645191192627,1.913105845451355,1.176734447479248,0.5754279494285583,0.18591882288455963,-0.3994935154914856,1.9705591201782227,2.6490659713745117,-0.759437084197998,-0.23889786005020142,-0.900497317314148,-1.4153908491134644,0.541402280330658,-0.2134995460510254,0.24751678109169006,0.6561787724494934,0.35915306210517883,3.5687508583068848,1.4349572658538818,-1.9755446910858154,-2.1722967624664307,-1.7886747121810913,-3.6240921020507812,-1.7883633375167847,-2.1531994342803955,-0.05177495628595352,-1.1518805027008057,-2.2381911277770996,-0.2777620553970337,-2.7935473918914795,-0.985107421875,-1.5737550258636475,-2.8648784160614014,-0.7926676273345947,-1.9847651720046997,-1.9565452337265015,-2.3109192848205566,-2.170433759689331,-2.046128273010254,-1.7884387969970703,-3.1766295433044434,-0.7652154564857483,-2.8208019733428955,-1.8925821781158447,-0.3248683512210846,-0.6802529096603394,-0.030026616528630257,0.22050660848617554,-1.0655189752578735,-1.0855458974838257,0.9682175517082214,-2.5945935249328613,-1.4845701456069946,-0.9860842227935791,-0.2501584589481354,-2.21254825592041,-0.9282965660095215,-0.5894380211830139,-2.2491068840026855,-1.3508793115615845,-2.069303274154663,-1.6948262453079224,0.9848254323005676,1.2485548257827759,0.9365651607513428,-1.2274106740951538,-1.7764509916305542,0.5567451119422913,-1.3579906225204468,-2.8065943717956543,-0.5851900577545166,-0.13392241299152374,-0.6354706883430481,1.0494153499603271,-0.35455286502838135,-2.4247593879699707,0.09886763244867325,0.014342203736305237,-1.8393536806106567,-1.2256815433502197,-0.19250613451004028,-1.3938517570495605,-2.2999706268310547,-0.45072028040885925,-1.0265564918518066,-0.11560125648975372,-0.9679169058799744,-1.5078604221343994,-3.00948166847229,-2.543466091156006,-3.6631100177764893,-2.847332715988159,-2.45154070854187,-1.5960808992385864,-1.6782920360565186,2.192574977874756]}]}

*** Test Cases ***

Test PYTORCH Model Inference Via UI (Triton on Kserve)
    [Documentation]    Test the deployment of an pytorch model in Kserve using Triton
    [Tags]    Sanity    Tier1       RunThisTest

    Open Data Science Projects Home Page
    Create Data Science Project    title=${PRJ_TITLE}    description=${PRJ_DESCRIPTION}
    ...    existing_project=${FALSE}
    Open Dashboard Settings    settings_page=Serving runtimes
    Upload Serving Runtime Template    runtime_filepath=${TRITON_RUNTIME_FILEPATH}
    ...    serving_platform=single    api_protocol=REST
    Serving Runtime Template Should Be Listed    displayed_name=${RUNTIME_NAME}
    ...    serving_platform=single
    Recreate S3 Data Connection    project_title=${PRJ_TITLE}    dc_name=model-serving-connection
    ...            aws_access_key=${S3.AWS_ACCESS_KEY_ID}    aws_secret_access=${S3.AWS_SECRET_ACCESS_KEY}
    ...            aws_bucket_name=mytritonbucket
    Deploy Kserve Model Via UI    model_name=${MODEL_NAME}    serving_runtime=kserve-tritonserver-pytorch-rest
    ...    data_connection=model-serving-connection    path=triton/model_repository/    model_framework=pytorch - 1
    Wait For Pods To Be Ready    label_selector=serving.kserve.io/inferenceservice=${MODEL_NAME}
    ...    namespace=${PRJ_TITLE}
    Run Keyword And Continue On Failure    Verify Model Inference With Retries
    ...    ${MODEL_NAME}    ${INFERENCE_REST_INPUT_PYTORCH}    ${EXPECTED_INFERENCE_REST_OUTPUT_PYTORCH}    token_auth=${FALSE}
    ...    project_title=${PRJ_TITLE}
    [Teardown]    Run Keywords    Clean All Models Of Current User    AND
    ...    Run Keyword If Test Failed    Get Kserve Events And Logs
    ...    model_name=${MODEL_NAME}    project_title=${PRJ_TITLE}

*** Keywords ***
Triton On Kserve Suite Setup
    [Documentation]    Suite setup steps for testing Triton. It creates some test variables
    ...                and runs RHOSi setup
    Set Library Search Order    SeleniumLibrary
    Skip If Component Is Not Enabled    kserve
    RHOSi Setup

    Launch Dashboard    ${TEST_USER.USERNAME}    ${TEST_USER.PASSWORD}    ${TEST_USER.AUTH_TYPE}
    ...    ${ODH_DASHBOARD_URL}    ${BROWSER.NAME}    ${BROWSER.OPTIONS}

    Fetch Knative CA Certificate    filename=openshift_ca_istio_knative.crt
    Clean All Models Of Current User



Triton On Kserve Suite Teardown
    [Documentation]    Suite teardown steps after testing DSG. It Deletes
    ...                all the DS projects created by the tests and run RHOSi teardown
    # Even if kw fails, deleting the whole project will also delete the model
    # Failure will be shown in the logs of the run nonetheless
    IF    ${MODEL_CREATED}
        Clean All Models Of Current User
    ELSE
       Log    Model not deployed, skipping deletion step during teardown    console=true
    END
    ${projects}=    Create List    ${PRJ_TITLE}
    Delete Data Science Projects From CLI   ocp_projects=${projects}
    # Will only be present on SM cluster runs, but keyword passes
    # if file does not exist
    Remove File    openshift_ca_istio_knative.crt
    SeleniumLibrary.Close All Browsers
    RHOSi Teardown